# dataqbs.com — Portfolio + RAG Chatbot

Personal portfolio site for [www.dataqbs.com](https://www.dataqbs.com) with a LinkedIn-style layout and an AI chatbot powered by RAG (Retrieval-Augmented Generation).

## Stack

| Layer | Technology | Notes |
|-------|-----------|-------|
| Frontend | Astro 4 + Svelte 4 | Hybrid SSR (nonce middleware) |
| Styling | Tailwind CSS 3 | Dark/light mode, responsive |
| Chatbot LLM | Groq API (Llama 3.3 70B) | Free tier: 30 RPM, 100K TPD |
| Embeddings | Cloudflare Workers AI (`bge-base-en-v1.5`) | 768 dims, free 10K req/day |
| Vector Search | Cosine similarity + semantic boost | 61 chunks, in-memory |
| Query Expansion | Keyword → synonym mapping | 14 topic categories |
| Source Priority | cv > cert > project > github | Score boost 0–0.05 |
| Hosting | Cloudflare Pages | Free, global CDN |
| Anti-bot | Cloudflare Turnstile | Invisible CAPTCHA (chat + contact) |
| WAF | Cloudflare Rate Limiting | 15 req/10s on /api/* |
| XSS Prevention | DOMPurify | Strict tag/attr allowlist |
| CSP | Nonce-based middleware | No unsafe-inline in script-src |
| Secret Scanning | gitleaks pre-commit | Blocks leaked keys at commit |
| Analytics | Cloudflare Web Analytics | Privacy-first, no cookies |
| CI/CD | GitHub Actions | Auto-deploy + re-index on push |
| i18n | ES / EN / DE | Browser language detection |
| Contact | Form → KV / console log | + social links |

## Architecture

```
Browser → index.html (static, CDN)
       → POST /api/chat
             │  1. Validate Turnstile token
             │  2. Embed query via Workers AI
             │  3. Query expansion (synonym mapping)
             │  4. Cosine similarity + source priority boost
             │  5. Top-10 chunks → build prompt
             │  6. Stream response from Groq
             └→ SSE response to browser

knowledge.json (static asset, generated at build time)
       ← build_knowledge.py
             │  1. Read CV data (src/data/cv.ts)
             │  2. Read certifications (src/data/certs.ts)
             │  3. Read READMEs from monorepo
             │  4. Chunk text (512 tokens, 64 overlap)
             │  5. Embed via Workers AI API
             └→ public/knowledge.json
```

## Project Structure

```
projects/dataqbs_site/
├── package.json
├── astro.config.mjs
├── tailwind.config.mjs
├── wrangler.toml
├── tsconfig.json
├── .env.example
├── public/
│   ├── favicon.svg
│   ├── robots.txt
│   ├── yo.jpeg              ← profile photo (copy manually)
│   ├── Profile.pdf           ← CV PDF (copy manually)
│   └── knowledge.json        ← generated by build pipeline
├── src/
│   ├── env.d.ts
│   ├── middleware.ts          ← CSP nonce injection (SSR)
│   ├── layouts/Layout.astro
│   ├── pages/
│   │   ├── index.astro
│   │   └── api/
│   │       ├── chat.ts       ← RAG chat endpoint
│   │       └── contact.ts    ← contact form endpoint
│   ├── components/
│   │   ├── Header.svelte
│   │   ├── ProfileCard.svelte
│   │   ├── ExperienceTimeline.svelte
│   │   ├── ProjectsGrid.svelte
│   │   ├── SkillsSection.svelte
│   │   ├── ContactSection.svelte
│   │   ├── Chatbot.svelte
│   │   └── Footer.svelte
│   ├── data/
│   │   ├── cv.ts
│   │   ├── certs.ts
│   │   └── projects.ts
│   ├── i18n/
│   │   ├── translations.ts
│   │   └── store.ts
│   ├── lib/
│   │   ├── types.ts
│   │   ├── chat.ts
│   │   └── markdown.ts
│   └── styles/global.css
├── scripts/
│   ├── build_knowledge.py
│   └── requirements.txt
└── knowledge/
    └── semantic_model.yaml
```

## Quick Start

### Prerequisites

- Node.js ≥ 20
- Python ≥ 3.10
- Cloudflare account (free)
- Groq API key ([console.groq.com](https://console.groq.com))

### Setup

```bash
cd projects/dataqbs_site

# 1. Install Node dependencies
npm install

# 2. Install Python dependencies (for knowledge pipeline)
pip install -r scripts/requirements.txt

# 3. Copy assets
cp ~/Downloads/yo.jpeg public/
cp ~/Downloads/Profile.pdf public/

# 4. Create .env from template
cp .env.example .env
# Edit .env with your keys: GROQ_API_KEY, TURNSTILE keys, CF credentials

# 5. Generate knowledge base (requires CF_ACCOUNT_ID + CF_API_TOKEN in .env)
python scripts/build_knowledge.py

# 6. Run dev server
npm run dev
```

### Deploy

```bash
# Manual deploy
npm run deploy

# Or push to main branch → GitHub Actions auto-deploys
```

### Environment Variables

Set these in Cloudflare Pages → Settings → Environment Variables:

| Variable | Required | Description |
|----------|----------|-------------|
| `GROQ_API_KEY` | Yes | Groq API key for LLM |
| `TURNSTILE_SECRET_KEY` | Yes | Cloudflare Turnstile secret |
| `GROQ_MODEL` | No | Default: `llama-3.3-70b-versatile` |
| `MAX_CHAT_TOKENS` | No | Default: `1024` |
| `MAX_CONTEXT_CHUNKS` | No | Default: `10` |
| `RATE_LIMIT_PER_MIN` | No | Default: `12` |

Set these in GitHub → Settings → Secrets (for CI/CD):

| Secret | Description |
|--------|-------------|
| `CF_ACCOUNT_ID` | Cloudflare account ID |
| `CF_API_TOKEN` | Cloudflare API token (Workers AI + Pages) |

## DNS Setup

Point `www.dataqbs.com` to Cloudflare Pages:

```
CNAME  www  →  dataqbs-site.pages.dev
```

Optional: redirect apex `dataqbs.com` → `www.dataqbs.com` via Cloudflare redirect rules or registrar settings.

## Updating Content

1. **CV / Experience / Skills**: Edit `src/data/cv.ts`
2. **Certifications**: Edit `src/data/certs.ts`
3. **Projects**: Edit `src/data/projects.ts`
4. **Translations**: Edit `src/i18n/translations.ts`
5. **Knowledge base**: Runs automatically on push via GitHub Actions, or manually: `python scripts/build_knowledge.py`

## Costs

| Service | Cost |
|---------|------|
| Cloudflare Pages | Free |
| Cloudflare Workers AI | Free (10K req/day) |
| Cloudflare Turnstile | Free |
| Cloudflare Web Analytics | Free |
| Groq API | Free (30 RPM, 100K TPD) |
| GitHub Actions | Free (2000 min/month) |
| **Total** | **$0/month** |

## Quality Assurance

### Site QA (automated)

**59 PASS / 0 FAIL / 10 WARN** — covers i18n, dark mode, accessibility, responsive layout, chatbot functionality, SEO meta tags.

### Chatbot Stress Test (100 HR interview questions)

| Category | Answered | Rate |
|----------|----------|------|
| Soft Skills | 10/10 | 100% |
| Scenario | 10/10 | 100% |
| Skills | 18/20 | 90% |
| Experience | 11/15 | 73% |
| Summary | 9/15 | 60% |
| Projects | 10/20 | 50% |
| **Total** | **68/100** | **68%** |

Test scripts and results are in `tests/`.

## Security Hardening

This site was hardened after a security audit inspired by the [Bloomberg article (2025)](https://www.bloomberg.com/news/features/2025-06-11/mexican-hacker-uses-ai-chatbot-claude-to-breach-government-data) about a hacker using AI/vibe-coding to breach government systems. All findings below were addressed:

### Audit Results (12/12 addressed)

| # | Finding | Severity | Status | Fix |
|---|---------|----------|--------|-----|
| 1 | API key in `.dev.vars` | CRITICAL | ✅ Fixed | Rotated key, `.dev.vars` in `.gitignore` |
| 2 | No CAPTCHA on chatbot | HIGH | ✅ Fixed | Cloudflare Turnstile (invisible) |
| 3 | No rate limiting | HIGH | ✅ Fixed | WAF rule: 15 req/10s on `/api/*` |
| 4 | No CAPTCHA on contact form | HIGH | ✅ Fixed | Turnstile on contact form too |
| 5 | XSS via `{@html}` | HIGH | ✅ Fixed | DOMPurify with strict allowlist |
| 6 | HTML injection in emails | MEDIUM | ✅ Fixed | `htmlEncode()` on all interpolated values |
| 7 | System prompt leaks PII | MEDIUM | ✅ Fixed | Removed WhatsApp, rates, pricing formulas |
| 8 | `knowledge.json` accessible | LOW | ⚠️ Partial | noindex + no-store headers (still downloadable) |
| 9 | Missing `.gitignore` patterns | MEDIUM | ✅ Fixed | `.env.local`, `.env.production`, `.dev.vars` |
| 10 | No pre-commit secret scan | MEDIUM | ✅ Fixed | gitleaks v8.21.2 pre-commit hook |
| 11 | CSP `unsafe-inline` | LOW | ✅ Fixed | Nonce-based CSP via Astro middleware |
| 12 | CORS `*` on API | LOW | ✅ Fixed | Locked to `https://www.dataqbs.com` |

### Security Architecture

```
Request → Cloudflare Edge
  ├── WAF Rate Limiting (15 req/10s per IP on /api/*)
  ├── Turnstile Challenge (invisible, verified server-side)
  └── CSP Nonce (per-request, injected by middleware)

/api/chat
  ├── Turnstile token validation (required)
  ├── In-memory rate limiter (backup)
  ├── DOMPurify on rendered markdown
  ├── System prompt: no PII, no pricing
  └── CORS: https://www.dataqbs.com only

/api/contact
  ├── Turnstile token validation (required)
  ├── In-memory rate limiter (backup)
  └── htmlEncode() on all email fields

Pre-commit
  └── gitleaks → blocks secrets before they reach git
```

### Security Checklist for New Sites

Use this as a template when deploying any new Cloudflare Pages + API site:

- [ ] **Secrets**: `.dev.vars` and `.env*` in `.gitignore`, keys in CF Pages secrets only
- [ ] **CAPTCHA**: Turnstile on every public form and API endpoint
- [ ] **Rate limiting**: WAF rule on `/api/*` (15 req/10s is a good default)
- [ ] **XSS**: DOMPurify on any `{@html}` or `dangerouslySetInnerHTML`
- [ ] **Email injection**: `htmlEncode()` on all user inputs in email templates
- [ ] **System prompts**: Never include phone numbers, pricing, internal names
- [ ] **CSP**: Nonce-based `script-src` via middleware — never `unsafe-inline`
- [ ] **CORS**: Lock `Access-Control-Allow-Origin` to your production domain
- [ ] **Secret scanning**: gitleaks pre-commit hook
- [ ] **Headers**: HSTS, X-Frame-Options DENY, X-Content-Type-Options nosniff
- [ ] **Static data files**: Add noindex + no-store if they contain business logic

## Live

- **Production**: [www.dataqbs.com](https://www.dataqbs.com)
- **Preview**: [dataqbs-site.pages.dev](https://dataqbs-site.pages.dev)
